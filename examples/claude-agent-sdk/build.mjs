import * as esbuild from "esbuild";
import { execSync } from "child_process";
import fs from "fs";
import path from "path";

// æ„å»ºé…ç½®
const BUILD_DIR = "build";
const RELEASE_DIR = "release";

// å…¥å£ç‚¹é…ç½®
const ENTRY_POINTS = [
  { name: "agent", entry: "agent.ts" },
];

// pkg ç›®æ ‡å¹³å°é…ç½®
const PKG_TARGETS = [
  "node20-macos-x64",
  "node20-macos-arm64",
  "node20-linux-x64",
  "node20-win-x64",
];

// æ¸…ç†ç›®å½•
function cleanDir(dir) {
  if (fs.existsSync(dir)) {
    fs.rmSync(dir, { recursive: true });
  }
  fs.mkdirSync(dir, { recursive: true });
}

// ä½¿ç”¨ esbuild æ„å»º CommonJS åŒ…
async function buildWithEsbuild() {
  console.log("ğŸ“¦ ä½¿ç”¨ esbuild æ„å»º CommonJS åŒ…...\n");

  cleanDir(BUILD_DIR);

  for (const { name, entry } of ENTRY_POINTS) {
    console.log(`  æ„å»º ${name}...`);

    await esbuild.build({
      entryPoints: [entry],
      bundle: true,
      platform: "node",
      target: "node20",
      format: "cjs",
      outfile: `${BUILD_DIR}/${name}.cjs`,
      minify: false, // ä¿æŒå¯è¯»æ€§ï¼Œæ–¹ä¾¿è°ƒè¯•
      sourcemap: false,
      // æ’é™¤æ— æ³•æ‰“åŒ…çš„åŸç”Ÿæ¨¡å—
      external: [],
      // å¤„ç† __dirname å’Œ __filename
      define: {},
      // å…è®¸åŠ¨æ€ require
      banner: {
        js: `
// Generated by esbuild - CommonJS bundle
const __importMetaUrl = require('url').pathToFileURL(__filename).href;
`,
      },
    });

    const stats = fs.statSync(`${BUILD_DIR}/${name}.cjs`);
    console.log(`  âœ… ${name}.cjs (${(stats.size / 1024).toFixed(1)} KB)`);
  }

  console.log("\nâœ… esbuild æ„å»ºå®Œæˆ\n");
}

// ä½¿ç”¨ pkg æ‰“åŒ…å¯æ‰§è¡Œæ–‡ä»¶
async function packageWithPkg() {
  console.log("ğŸ”§ ä½¿ç”¨ pkg æ‰“åŒ…å¯æ‰§è¡Œæ–‡ä»¶...\n");

  cleanDir(RELEASE_DIR);

  for (const { name } of ENTRY_POINTS) {
    const inputFile = `${BUILD_DIR}/${name}.cjs`;

    for (const target of PKG_TARGETS) {
      const [, os, arch] = target.match(/node\d+-(\w+)-(\w+)/);
      const ext = os === "win" ? ".exe" : "";
      const outputName = `${name}-${os}-${arch}${ext}`;
      const outputPath = `${RELEASE_DIR}/${outputName}`;

      console.log(`  æ‰“åŒ… ${outputName}...`);

      try {
        execSync(
          `npx pkg ${inputFile} --target ${target} --output ${outputPath}`,
          {
            stdio: "pipe",
          }
        );

        const stats = fs.statSync(outputPath);
        console.log(
          `  âœ… ${outputName} (${(stats.size / 1024 / 1024).toFixed(1)} MB)`
        );
      } catch (error) {
        console.error(`  âŒ æ‰“åŒ… ${outputName} å¤±è´¥:`, error.message);
      }
    }
  }

  console.log("\nâœ… pkg æ‰“åŒ…å®Œæˆ\n");
}

// ç”Ÿæˆ SHA256 æ ¡éªŒå’Œ
function generateChecksums() {
  console.log("ğŸ” ç”Ÿæˆ SHA256 æ ¡éªŒå’Œ...\n");

  const checksums = [];
  const files = fs.readdirSync(RELEASE_DIR);

  for (const file of files) {
    if (file === "checksums.txt") continue;

    const filePath = path.join(RELEASE_DIR, file);
    const hash = execSync(`shasum -a 256 "${filePath}"`).toString().trim();
    checksums.push(hash);
    console.log(`  ${hash.split("  ")[0].slice(0, 16)}... ${file}`);
  }

  fs.writeFileSync(`${RELEASE_DIR}/checksums.txt`, checksums.join("\n") + "\n");
  console.log(`\nâœ… checksums.txt å·²ç”Ÿæˆ\n`);
}

// æ˜¾ç¤ºæ„å»ºç»“æœ
function showResults() {
  console.log("â•".repeat(60));
  console.log("ğŸ“‹ æ„å»ºç»“æœ");
  console.log("â•".repeat(60));

  const files = fs.readdirSync(RELEASE_DIR);
  for (const file of files) {
    const filePath = path.join(RELEASE_DIR, file);
    const stats = fs.statSync(filePath);
    const size =
      stats.size > 1024 * 1024
        ? `${(stats.size / 1024 / 1024).toFixed(1)} MB`
        : `${(stats.size / 1024).toFixed(1)} KB`;
    console.log(`  ${file.padEnd(35)} ${size}`);
  }

  console.log("â•".repeat(60));
  console.log(`\nğŸ’¡ ä½¿ç”¨æ–¹æ³•:`);
  console.log(`   macOS (Intel):  ./release/agent-macos-x64`);
  console.log(`   macOS (Apple):  ./release/agent-macos-arm64`);
  console.log(`   Linux:          ./release/agent-linux-x64`);
  console.log(`   Windows:        .\\release\\agent-win-x64.exe`);
  console.log("");
}

// ä¸»å‡½æ•°
async function main() {
  const args = process.argv.slice(2);
  const skipPkg = args.includes("--skip-pkg");

  console.log("");
  console.log("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  console.log("â•‘              ğŸš€ Build Release Packages                        â•‘");
  console.log("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  console.log("");

  try {
    // æ­¥éª¤ 1: esbuild æ„å»º
    await buildWithEsbuild();

    if (!skipPkg) {
      // æ­¥éª¤ 2: pkg æ‰“åŒ…
      await packageWithPkg();

      // æ­¥éª¤ 3: ç”Ÿæˆæ ¡éªŒå’Œ
      generateChecksums();

      // æ˜¾ç¤ºç»“æœ
      showResults();
    } else {
      console.log("â­ï¸  è·³è¿‡ pkg æ‰“åŒ… (--skip-pkg)\n");
      console.log(`ğŸ“ CommonJS åŒ…å·²ç”Ÿæˆåˆ° ${BUILD_DIR}/ ç›®å½•`);
    }
  } catch (error) {
    console.error("\nâŒ æ„å»ºå¤±è´¥:", error);
    process.exit(1);
  }
}

main();

